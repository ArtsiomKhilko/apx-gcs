cmake_minimum_required(VERSION 3.19 FATAL_ERROR)

# paths used by apx_module
get_filename_component(APX_SHARED_DIR "${CMAKE_CURRENT_SOURCE_DIR}/../lib" ABSOLUTE)
get_filename_component(APX_MODULES_DIR "${CMAKE_CURRENT_SOURCE_DIR}/src" ABSOLUTE)

list(APPEND CMAKE_MODULE_PATH ${APX_SHARED_DIR}/cmake)
list(APPEND CMAKE_MODULE_PATH ${CMAKE_CURRENT_SOURCE_DIR}/cmake)

set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/static)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/lib)
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}/bin)

get_filename_component(APX_RESOURCES_DIR "${CMAKE_SOURCE_DIR}/resources" ABSOLUTE)

# LTO
set(CMAKE_INTERPROCEDURAL_OPTIMIZATION ON)

option(CMAKE_VERBOSE_MAKEFILE "" OFF)

set(CMAKE_PREFIX_PATH
    "$ENV{HOME}/QtOS/5.15.2/clang_64"
    CACHE PATH "Qt installation path"
)

# set(DESTDIR
#     ""
#     CACHE PATH ""
# )
set(CMAKE_INSTALL_PREFIX
    "${CMAKE_CURRENT_BINARY_DIR}/install"
    CACHE PATH ""
)

set(CMAKE_OSX_DEPLOYMENT_TARGET
    "10.13"
    CACHE STRING "Minimum OS X deployment version"
)

# set(CMAKE_MACOSX_BUNDLE ON)
# set(CMAKE_MACOSX_RPATH ON)

include(apx)
include(git)

set(APX_COPYRIGHT "(C) ${APX_GIT_YEAR} Aliaksei Stratsilatau (sa@uavos.com)")

project(
    gcs
    VERSION ${APX_GIT_VERSION}
    DESCRIPTION "APX Ground Control"
    HOMEPAGE_URL "http://docs.uavos.com"
    LANGUAGES CXX C
)

include(ccache)

set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTORCC ON)
set(CMAKE_AUTOUIC ON)

find_package(
    Qt5
    COMPONENTS Widgets
    REQUIRED
)

include(apx_gcs_qt)
include(apx_gcs_qrc)
include(apx_gcs_bundle)
include(apx_gcs_lib)
include(apx_gcs_install)

apx_use_module("main")

# app dist package

# install(TARGETS ${PROJECT_NAME}
#         RUNTIME DESTINATION . COMPONENT Runtime
# )

set(CPACK_PACKAGE_VENDOR "UAVOS")
set(CPACK_PACKAGE_CONTACT "sa@uavos.com")
set(CPACK_PACKAGE_VERSION "${PROJECT_VERSION}")
set(CPACK_PACKAGE_ICON "${APX_RESOURCES_DIR}/icons/uavos-logo.ico")

set(CPACK_PACKAGE_NAME ${PROJECT_DESCRIPTION})
string(TOLOWER ${CMAKE_SYSTEM_NAME} CPACK_SYSTEM_NAME)
set(CPACK_PACKAGE_FILE_NAME ${PROJECT_DESCRIPTION}-${PROJECT_VERSION}-${CPACK_SYSTEM_NAME})
string(REPLACE " " "_" CPACK_PACKAGE_FILE_NAME ${CPACK_PACKAGE_FILE_NAME})

if(APPLE)
    list(APPEND CPACK_GENERATOR "Bundle")

    set(CPACK_BUNDLE_NAME ${PROJECT_DESCRIPTION})
    set(CPACK_BUNDLE_PLIST Info.plist)
    set(CPACK_BUNDLE_ICON "${APX_RESOURCES_DIR}/icons/uavos-logo.icns")

    set(MACOSX_BUNDLE_BUNDLE_NAME ${PROJECT_DESCRIPTION})
    set(MACOSX_BUNDLE_BUNDLE_VERSION ${PROJECT_VERSION})
    set(MACOSX_BUNDLE_COPYRIGHT ${APX_COPYRIGHT})
    set(MACOSX_BUNDLE_GUI_IDENTIFIER com.uavos.apx.${PROJECT_NAME})
    set(MACOSX_BUNDLE_SHORT_VERSION_STRING ${PROJECT_VERSION})
    set(MACOSX_BUNDLE_EXECUTABLE_NAME ${PROJECT_NAME})
    set(MACOSX_BUNDLE_ICON_FILE /${PROJECT_DESCRIPTION}.icns)

    configure_file(${APX_RESOURCES_DIR}/macos/Info.plist.in Info.plist)

    # main exe
    # set(CPACK_BUNDLE_STARTUP_COMMAND "${APX_RESOURCES_DIR}/icons/uavos-logo.icns")

    # list(APPEND CPACK_GENERATOR "DragNDrop")
    set(CPACK_DMG_FORMAT "UDBZ")
    set(CPACK_DMG_VOLUME_NAME "${PROJECT_DESCRIPTION}-${PROJECT_VERSION}")
endif()
if(UNIX AND NOT APPLE)
    list(APPEND CPACK_GENERATOR "TBZ2")
endif()
if(WIN32)
    list(APPEND CPACK_GENERATOR "7Z")
    set(CPACK_INCLUDE_TOPLEVEL_DIRECTORY OFF)
endif()

# set(CPACK_INSTALL_CMAKE_PROJECTS "${CMAKE_CURRENT_BINARY_DIR};gcs;ALL;/")

include(CPack)
